<%-include('../../views/partials/admin/header') %>

<div class="content">
  <h3>Category</h3>

  <!-- Search Bar Form -->
  <form method="GET" action="/admin/category">
    <div class="form-group d-flex">
      <input 
        type="text" 
        name="search" 
        class="form-control" 
        placeholder="Search for customers..." 
        value=""
      >
      <button type="submit" class="btn btn-primary ml-2">Search</button>
    </div>
  </form>
  
  <!-- Add Category Form -->
  <form method="POST" action="/admin/addCategory" onsubmit="return handleFormSubmit(event)">
    <div class="form-group">
      <label for="categoryName">Category Name</label>
      <input type="text" class="form-control" id="categoryName" name="name" placeholder="Enter category name" >
      <div id="name-error" class="error-message text-danger" ></div>
    </div>
    
    <div class="form-group">
      <label for="categoryDescription">Description</label>
      <textarea class="form-control" id="categoryDescription" name="description" rows="3" placeholder="Enter category description" ></textarea>
      <div id="description-error" class="error-message text-danger"></div>
    </div>
    <button type="submit" class="btn btn-primary">Add Category</button>
  </form>
  
  <hr>

  <!-- Categories Table -->
  <h4>Category List</h4>
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Offer</th>
        <th>Status</th>
        <th>List/Unlist</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% cat.reverse().forEach((category, index) => { %>
      <tr>
        <td><%= category.name %></td>
        <td><%= category.description %></td>
        <td>
          <button class="btn btn-success btn-sm">Add Offer</button>
          <button class="btn btn-danger btn-sm">Remove Offer</button>
        </td>
        <td>
          <%= category.status === 'listed' ? 'Listed' : 'Unlisted' %>
        </td>
        <td>
          <% if (category.status === 'listed') { %>
          <button class="btn btn-danger btn-sm">Unlist</button>
          <% } else { %>
          <button class="btn btn-success btn-sm">List</button>
          <% } %>
        </td>
        <td>
          <button class="btn btn-warning btn-sm">Edit</button>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <%-include('../../views/partials/admin/pagination') %>
</div>


<script>
  function handleFormSubmit(e) {
    e.preventDefault();
    if (!validateForm()) {
      return;
    }
    const name = document.getElementsByName('name')[0].value.trim();
    const description = document.getElementById('categoryDescription').value.trim();

    fetch("/admin/addCategory", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ name, description }),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((err) => {
            throw new Error(err.error);
          });
        }
        return response.json();
      })
      .then((data) => {
        location.reload();
      })
      .catch((error) => {
        if (error.message === "Category already exists") {
          Swal.fire({
            icon: "error",
            title: "Oops",
            text: "Category already exists",
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oops",
            text: "An error occurred while adding the category.",
          });
        }
      });
  }

  function validateForm() {
    clearErrorMessages();
    const name = document.getElementsByName("name")[0].value.trim();
    const description = document.getElementById("categoryDescription").value.trim();
    let isValid = true;

    if (name === "") {
      displayErrorMessage("name-error", "Please enter a name");
      isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(name)) {
      displayErrorMessage("name-error", "Category name should contain only alphabetic characters");
      isValid = false;
    }

    if (description === "") {
      displayErrorMessage("description-error", "Please enter a description");
      isValid = false;
    }
    return isValid;
  }

  function displayErrorMessage(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.innerText = message;
    errorElement.style.display = "block";
  }

  function clearErrorMessages() {
    const errorElements = document.getElementsByClassName("error-message");
    Array.from(errorElements).forEach((element) => {
      element.innerText = "";
      element.style.display = "none";
    });
  }
</script>


<%-include('../../views/partials/admin/footer') %>